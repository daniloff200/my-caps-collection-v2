<div class="form-page">
  <div class="form-page__header">
    <h1 class="form-page__title">{{ (isEditMode ? 'FORM.EDIT_TITLE' : 'FORM.ADD_TITLE') | translate }}</h1>
    <p class="form-page__subtitle">{{ (isEditMode ? 'FORM.EDIT_SUBTITLE' : 'FORM.ADD_SUBTITLE') | translate }}</p>
  </div>

  <form class="form" #capForm="ngForm" (ngSubmit)="onSubmit(capForm)">
    <!-- Name -->
    <div class="form__group">
      <label class="form__label" for="name">{{ 'FORM.NAME' | translate }} *</label>
      <input
        type="text"
        id="name"
        class="form__input"
        [class.form__input--error]="nameField.invalid && nameField.touched"
        [placeholder]="'FORM.NAME_PLACEHOLDER' | translate"
        [(ngModel)]="name"
        name="name"
        #nameField="ngModel"
        required
      />
      <span class="form__error" *ngIf="nameField.invalid && nameField.touched">
        {{ 'FORM.NAME_REQUIRED' | translate }}
      </span>
    </div>

    <!-- Country & Manufacturer -->
    <div class="form__row">
      <div class="form__group">
        <label class="form__label" for="country">{{ 'FORM.COUNTRY' | translate }} *</label>
        <select
          id="country"
          class="form__select"
          [class.form__input--error]="countryField.invalid && countryField.touched"
          [(ngModel)]="country"
          name="country"
          #countryField="ngModel"
          required
        >
          <option value="" disabled>{{ 'FORM.SELECT_COUNTRY' | translate }}</option>
          <option *ngFor="let c of countries" [value]="c">{{ c }} {{ c | countryFlagEmoji }}</option>
        </select>
        <span class="form__error" *ngIf="countryField.invalid && countryField.touched">
          {{ 'FORM.COUNTRY_REQUIRED' | translate }}
        </span>
      </div>

      <div class="form__group">
        <label class="form__label" for="manufacturer">{{ 'FORM.MANUFACTURER' | translate }} *</label>
        <input
          type="text"
          id="manufacturer"
          class="form__input"
          [class.form__input--error]="manufacturerField.invalid && manufacturerField.touched"
          [placeholder]="'FORM.MANUFACTURER_PLACEHOLDER' | translate"
          [(ngModel)]="manufacturer"
          name="manufacturer"
          #manufacturerField="ngModel"
          required
        />
        <span class="form__error" *ngIf="manufacturerField.invalid && manufacturerField.touched">
          {{ 'FORM.MANUFACTURER_REQUIRED' | translate }}
        </span>
      </div>
    </div>

    <!-- Tags -->
    <div class="form__group">
      <label class="form__label">{{ 'FORM.TAGS' | translate }}</label>
      <div class="tags-input">
        <div class="tags-input__current" *ngIf="tags.length">
          <app-tag-badge
            *ngFor="let tag of tags"
            [tag]="tag"
            [removable]="true"
            (tagRemove)="removeTag($event)"
          ></app-tag-badge>
        </div>
        <div class="tags-input__field">
          <input
            type="text"
            class="form__input"
            [placeholder]="'FORM.TAGS_PLACEHOLDER' | translate"
            [(ngModel)]="customTag"
            name="customTag"
            (keydown)="onTagInputKeydown($event)"
            (focus)="onTagInputFocus()"
            (blur)="onTagInputBlur()"
          />
          <div class="tags-input__suggestions" *ngIf="showTagSuggestions && filteredSuggestions.length">
            <button
              type="button"
              class="tags-input__suggestion"
              *ngFor="let suggestion of filteredSuggestions"
              (click)="addTag(suggestion)"
            >
              {{ suggestion }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Upload -->
    <div class="form__group">
      <label class="form__label">{{ 'FORM.PHOTO' | translate }}</label>

      <!-- Drop zone (when no image) -->
      <div
        *ngIf="!imagePreview && !imageUrl"
        class="upload-zone"
        [class.upload-zone--active]="isDragging"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()"
      >
        <input
          #fileInput
          type="file"
          accept="image/*"
          class="upload-zone__input"
          (change)="onFileSelected($event)"
        />
        <div class="upload-zone__icon">ðŸ“·</div>
        <div class="upload-zone__text">
          <span class="upload-zone__main">{{ 'FORM.UPLOAD_TEXT' | translate }}</span>
          <span class="upload-zone__hint">{{ 'FORM.UPLOAD_HINT' | translate }}</span>
        </div>
      </div>

      <!-- Preview (when image selected or existing URL) -->
      <div class="upload-preview" *ngIf="imagePreview || imageUrl">
        <div class="upload-preview__image">
          <img [src]="imagePreview || imageUrl" alt="Cap photo" />
        </div>
        <div class="upload-preview__info">
          <div class="upload-preview__sizes" *ngIf="originalSize">
            <span class="upload-preview__original">
              {{ 'FORM.ORIGINAL' | translate }}: {{ formatSize(originalSize) }}
            </span>
            <span class="upload-preview__arrow" *ngIf="compressedSize">â†’</span>
            <span class="upload-preview__compressed" *ngIf="compressedSize">
              {{ 'FORM.COMPRESSED' | translate }}: {{ formatSize(compressedSize) }}
            </span>
            <span class="upload-preview__saving" *ngIf="compressedSize && originalSize">
              ({{ 'FORM.SAVED' | translate }} {{ ((1 - compressedSize / originalSize) * 100).toFixed(0) }}%)
            </span>
            <span class="upload-preview__compressing" *ngIf="compressing">
              {{ 'FORM.COMPRESSING' | translate }}
            </span>
          </div>
          <div class="upload-preview__existing" *ngIf="!originalSize && imageUrl">
            {{ 'FORM.CURRENT_PHOTO' | translate }}
          </div>
          <div class="upload-preview__actions">
            <button
              type="button"
              class="upload-preview__change"
              (click)="fileInput.click()"
            >
              {{ 'FORM.CHANGE_PHOTO' | translate }}
            </button>
            <input
              #fileInput
              type="file"
              accept="image/*"
              class="upload-zone__input"
              (change)="onFileSelected($event)"
            />
            <button
              type="button"
              class="upload-preview__remove"
              (click)="removeImage()"
            >
              {{ 'FORM.REMOVE' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Description -->
    <div class="form__group">
      <label class="form__label" for="description">{{ 'FORM.DESCRIPTION' | translate }}</label>
      <textarea
        id="description"
        class="form__textarea"
        [placeholder]="'FORM.DESCRIPTION_PLACEHOLDER' | translate"
        [(ngModel)]="description"
        name="description"
        rows="3"
      ></textarea>
    </div>

    <!-- For Trade & Needs Replacement -->
    <div class="form__group form__group--checkbox">
      <label class="form__checkbox">
        <input
          type="checkbox"
          [(ngModel)]="forTrade"
          name="forTrade"
        />
        <span class="form__checkbox-mark"></span>
        <span class="form__checkbox-text">{{ 'FORM.FOR_TRADE' | translate }}</span>
      </label>
    </div>

    <div class="form__group form__group--checkbox">
      <label class="form__checkbox form__checkbox--replace">
        <input
          type="checkbox"
          [(ngModel)]="needsReplacement"
          name="needsReplacement"
        />
        <span class="form__checkbox-mark form__checkbox-mark--replace"></span>
        <span class="form__checkbox-text">{{ 'FORM.NEEDS_REPLACEMENT' | translate }}</span>
      </label>
    </div>

    <!-- Actions -->
    <div class="form__actions">
      <button type="button" class="btn btn--ghost" (click)="cancel()" [disabled]="saving">{{ 'FORM.CANCEL' | translate }}</button>
      <button type="submit" class="btn btn--primary" [disabled]="saving">
        {{ saving ? ('FORM.SAVING' | translate) : ((isEditMode ? 'FORM.SAVE_CHANGES' : 'FORM.ADD_TO_COLLECTION') | translate) }}
      </button>
    </div>
  </form>
</div>
