<div class="form-page">
  <div class="form-page__header">
    <h1 class="form-page__title">{{ isEditMode ? 'Edit Cap' : 'Add New Cap' }}</h1>
    <p class="form-page__subtitle">{{ isEditMode ? 'Update cap information' : 'Add a new crown cap to your collection' }}</p>
  </div>

  <form class="form" #capForm="ngForm" (ngSubmit)="onSubmit(capForm)">
    <!-- Name -->
    <div class="form__group">
      <label class="form__label" for="name">Name *</label>
      <input
        type="text"
        id="name"
        class="form__input"
        [class.form__input--error]="nameField.invalid && nameField.touched"
        placeholder="e.g. Pilsner Urquell"
        [(ngModel)]="name"
        name="name"
        #nameField="ngModel"
        required
      />
      <span class="form__error" *ngIf="nameField.invalid && nameField.touched">
        Name is required
      </span>
    </div>

    <!-- Country & Manufacturer -->
    <div class="form__row">
      <div class="form__group">
        <label class="form__label" for="country">Country *</label>
        <select
          id="country"
          class="form__select"
          [class.form__input--error]="countryField.invalid && countryField.touched"
          [(ngModel)]="country"
          name="country"
          #countryField="ngModel"
          required
        >
          <option value="" disabled>Select country</option>
          <option *ngFor="let c of countries" [value]="c">{{ c }}</option>
        </select>
        <span class="form__error" *ngIf="countryField.invalid && countryField.touched">
          Country is required
        </span>
      </div>

      <div class="form__group">
        <label class="form__label" for="manufacturer">Manufacturer *</label>
        <input
          type="text"
          id="manufacturer"
          class="form__input"
          [class.form__input--error]="manufacturerField.invalid && manufacturerField.touched"
          placeholder="e.g. PlzeÅˆskÃ½ Prazdroj"
          [(ngModel)]="manufacturer"
          name="manufacturer"
          #manufacturerField="ngModel"
          required
        />
        <span class="form__error" *ngIf="manufacturerField.invalid && manufacturerField.touched">
          Manufacturer is required
        </span>
      </div>
    </div>

    <!-- Tags -->
    <div class="form__group">
      <label class="form__label">Tags</label>
      <div class="tags-input">
        <div class="tags-input__current" *ngIf="tags.length">
          <app-tag-badge
            *ngFor="let tag of tags"
            [tag]="tag"
            [removable]="true"
            (tagRemove)="removeTag($event)"
          ></app-tag-badge>
        </div>
        <div class="tags-input__field">
          <input
            type="text"
            class="form__input"
            placeholder="Type a tag and press Enter, or choose from suggestions"
            [(ngModel)]="customTag"
            name="customTag"
            (keydown)="onTagInputKeydown($event)"
            (focus)="onTagInputFocus()"
            (blur)="onTagInputBlur()"
          />
          <div class="tags-input__suggestions" *ngIf="showTagSuggestions && filteredSuggestions.length">
            <button
              type="button"
              class="tags-input__suggestion"
              *ngFor="let suggestion of filteredSuggestions"
              (click)="addTag(suggestion)"
            >
              {{ suggestion }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Upload -->
    <div class="form__group">
      <label class="form__label">Photo</label>

      <!-- Drop zone (when no image) -->
      <div
        *ngIf="!imagePreview && !imageUrl"
        class="upload-zone"
        [class.upload-zone--active]="isDragging"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()"
      >
        <input
          #fileInput
          type="file"
          accept="image/*"
          class="upload-zone__input"
          (change)="onFileSelected($event)"
        />
        <div class="upload-zone__icon">ðŸ“·</div>
        <div class="upload-zone__text">
          <span class="upload-zone__main">Click to upload or drag & drop</span>
          <span class="upload-zone__hint">Image will be auto-compressed to ~100KB</span>
        </div>
      </div>

      <!-- Preview (when image selected or existing URL) -->
      <div class="upload-preview" *ngIf="imagePreview || imageUrl">
        <div class="upload-preview__image">
          <img [src]="imagePreview || imageUrl" alt="Cap photo" />
        </div>
        <div class="upload-preview__info">
          <div class="upload-preview__sizes" *ngIf="originalSize">
            <span class="upload-preview__original">
              Original: {{ formatSize(originalSize) }}
            </span>
            <span class="upload-preview__arrow" *ngIf="compressedSize">â†’</span>
            <span class="upload-preview__compressed" *ngIf="compressedSize">
              Compressed: {{ formatSize(compressedSize) }}
            </span>
            <span class="upload-preview__saving" *ngIf="compressedSize && originalSize">
              (saved {{ ((1 - compressedSize / originalSize) * 100).toFixed(0) }}%)
            </span>
            <span class="upload-preview__compressing" *ngIf="compressing">
              Compressing...
            </span>
          </div>
          <div class="upload-preview__existing" *ngIf="!originalSize && imageUrl">
            Current photo
          </div>
          <div class="upload-preview__actions">
            <button
              type="button"
              class="upload-preview__change"
              (click)="fileInput.click()"
            >
              Change photo
            </button>
            <input
              #fileInput
              type="file"
              accept="image/*"
              class="upload-zone__input"
              (change)="onFileSelected($event)"
            />
            <button
              type="button"
              class="upload-preview__remove"
              (click)="removeImage()"
            >
              Remove
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Description -->
    <div class="form__group">
      <label class="form__label" for="description">Description</label>
      <textarea
        id="description"
        class="form__textarea"
        placeholder="What makes this cap special?"
        [(ngModel)]="description"
        name="description"
        rows="3"
      ></textarea>
    </div>

    <!-- For Trade -->
    <div class="form__group form__group--checkbox">
      <label class="form__checkbox">
        <input
          type="checkbox"
          [(ngModel)]="forTrade"
          name="forTrade"
        />
        <span class="form__checkbox-mark"></span>
        <span class="form__checkbox-text">Available for trade</span>
      </label>
    </div>

    <!-- Actions -->
    <div class="form__actions">
      <button type="button" class="btn btn--ghost" (click)="cancel()" [disabled]="saving">Cancel</button>
      <button type="submit" class="btn btn--primary" [disabled]="saving">
        {{ saving ? 'Saving...' : (isEditMode ? 'Save Changes' : 'Add to Collection') }}
      </button>
    </div>
  </form>
</div>
